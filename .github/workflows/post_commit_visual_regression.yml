name: Post-Commit Visual Regression

on:
  push:
    branches: [main, develop]
    paths:
      - 'outputs/**'
      - 'golden/**'
      - '!golden/**/*.md'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run visual regression on'
        required: false
        default: 'main'
        type: string
      force_run:
        description: 'Force run even if no images found'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  check-for-images:
    runs-on: ubuntu-latest
    outputs:
      has_images: ${{ steps.check.outputs.has_images }}
      image_count: ${{ steps.check.outputs.image_count }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
      with:
        ref: ${{ inputs.branch || github.ref }}
        lfs: true
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Check for test images
      id: check
      run: |
        set -euo pipefail
        
        echo "=== Post-Commit Visual Regression Check ==="
        echo "Checking for test images to compare..."
        echo "Triggered by: ${{ github.event_name }}"
        echo "Branch: ${{ inputs.branch || github.ref_name }}"
        echo "Force run: ${{ inputs.force_run || false }}"
        echo "============================================"
        
        # Check if outputs directory exists and has images
        HAS_IMAGES=false
        IMAGE_COUNT=0
        
        if [ -d "outputs" ] && [ -n "$(ls -A outputs/*.png 2>/dev/null)" ]; then
          IMAGE_COUNT=$(ls -1 outputs/*.png 2>/dev/null | wc -l)
          HAS_IMAGES=true
          echo "âœ… Found $IMAGE_COUNT test images in outputs/ directory:"
          ls -la outputs/
        elif [ "${{ inputs.force_run || false }}" = "true" ]; then
          echo "âš ï¸ No test images found, but force_run is enabled"
          echo "Will generate sample images for testing purposes"
          HAS_IMAGES=true
          IMAGE_COUNT=0
        else
          echo "â„¹ï¸ No test images found in outputs/ directory"
          echo "Post-commit visual regression will be skipped"
          echo ""
          echo "This is normal if:"
          echo "  - No visual changes were made in this commit"
          echo "  - Test images are generated by a separate CI process" 
          echo "  - This commit only contains code changes without visual outputs"
          echo ""
          echo "To force run visual regression testing:"
          echo "  - Use workflow_dispatch with force_run=true"
          echo "  - Or ensure test images are committed to outputs/ directory"
        fi
        
        echo "has_images=$HAS_IMAGES" >> $GITHUB_OUTPUT
        echo "image_count=$IMAGE_COUNT" >> $GITHUB_OUTPUT

  post-commit-visual-regression:
    needs: check-for-images
    if: needs.check-for-images.outputs.has_images == 'true'
    uses: ./.github/workflows/visual-diff.yml
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
    with:
      outputs_directory: 'outputs'
      test_mode: ${{ needs.check-for-images.outputs.image_count == '0' }}
      artifact_suffix: 'post-commit'
      # Note: No pr_number provided since this runs on push, not PR
      # Results will be logged to workflow output instead of PR comments

  notify-on-changes:
    needs: [check-for-images, post-commit-visual-regression]
    runs-on: ubuntu-latest
    if: always() && needs.check-for-images.outputs.has_images == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@0ad4b8fadaa221de15dcec353f45205ec38ea70b # v4.1.4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get commit details
      id: commit
      run: |
        COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
        COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
        COMMIT_HASH=$(git log -1 --pretty=format:'%h')
        
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT  
        echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
    
    - name: Summarize post-commit visual regression results
      uses: actions/github-script@v7
      with:
        script: |
          const commitMessage = '${{ steps.commit.outputs.commit_message }}';
          const commitAuthor = '${{ steps.commit.outputs.commit_author }}';
          const commitHash = '${{ steps.commit.outputs.commit_hash }}';
          const visualRegressionResult = '${{ needs.post-commit-visual-regression.result }}';
          const imageCount = '${{ needs.check-for-images.outputs.image_count }}';
          
          console.log('='.repeat(60));
          console.log('POST-COMMIT VISUAL REGRESSION SUMMARY');
          console.log('='.repeat(60));
          console.log('ðŸ“ Commit: ' + commitHash + ' - ' + commitMessage);
          console.log('ðŸ‘¤ Author: ' + commitAuthor);
          console.log('ðŸŒ¿ Branch: ${{ github.ref_name }}');
          console.log('ðŸ–¼ï¸ Images: ' + imageCount + ' test images processed');
          console.log('ðŸ“Š Result: ' + visualRegressionResult.toUpperCase());
          console.log('');
          
          // Create comprehensive workflow summary for better visibility
          let summaryContent = `# ðŸ“Š Post-Commit Visual Regression Summary\n\n`;
          summaryContent += `**ðŸ• Test Run:** ${new Date().toISOString().replace('T', ' ').substring(0, 19)} UTC\n\n`;
          summaryContent += `## ðŸ“ Commit Details\n`;
          summaryContent += `- **Hash:** \`${commitHash}\`\n`;
          summaryContent += `- **Message:** ${commitMessage}\n`;
          summaryContent += `- **Author:** ${commitAuthor}\n`;
          summaryContent += `- **Branch:** \`${{ github.ref_name }}\`\n\n`;
          summaryContent += `## ðŸ–¼ï¸ Test Results\n`;
          summaryContent += `- **Images Processed:** ${imageCount}\n`;
          summaryContent += `- **Overall Result:** ${visualRegressionResult.toUpperCase()}\n\n`;
          
          if (visualRegressionResult === 'success') {
            console.log('âœ… VISUAL REGRESSION TEST PASSED');
            console.log('   All images match their golden masters or were accepted');
            console.log('   No visual regressions detected in this commit');
            
            summaryContent += `## âœ… Test Status: PASSED\n\n`;
            summaryContent += `All generated images match their golden master references within acceptable tolerance.\n\n`;
            summaryContent += `**No visual regressions detected** - this commit is safe from a visual perspective.\n\n`;
          } else if (visualRegressionResult === 'failure') {
            console.log('âŒ VISUAL REGRESSION TEST FAILED');
            console.log('   Visual changes detected that may need review');
            console.log('   Check the visual-diff workflow results for details');
            console.log('');
            console.log('ðŸ“¦ Download Results:');
            console.log('   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}');
            
            summaryContent += `## âŒ Test Status: FAILED\n\n`;
            summaryContent += `**Visual changes detected** that may indicate regressions or need review.\n\n`;
            summaryContent += `### ðŸ” Next Steps:\n`;
            summaryContent += `1. Review the detailed visual diff results in the workflow artifacts\n`;
            summaryContent += `2. Check if the visual changes are intentional\n`;
            summaryContent += `3. If changes are expected, update the golden master images\n`;
            summaryContent += `4. If changes are not expected, investigate the root cause\n\n`;
          } else {
            console.log('âš ï¸ VISUAL REGRESSION TEST INCONCLUSIVE');
            console.log('   The test completed but results are unclear');
            console.log('   Check the workflow logs for more information');
            
            summaryContent += `## âš ï¸ Test Status: INCONCLUSIVE\n\n`;
            summaryContent += `The visual regression test completed but the results are unclear.\n\n`;
            summaryContent += `### ðŸ” Troubleshooting:\n`;
            summaryContent += `1. Check the workflow logs for specific error messages\n`;
            summaryContent += `2. Verify test images were generated correctly\n`;
            summaryContent += `3. Ensure golden master images are accessible\n\n`;
          }
          
          summaryContent += `## ðŸ“¦ Detailed Results\n\n`;
          summaryContent += `For complete visual diff analysis, download the workflow artifacts:\n\n`;
          summaryContent += `ðŸ”— **[View Complete Results & Download Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})**\n\n`;
          summaryContent += `### Artifact Contents:\n`;
          summaryContent += `- **Visual Test Results** - Complete comparison report with image analysis\n`;
          summaryContent += `- **Diff Images** - Visual differences highlighted for easy review\n`;
          summaryContent += `- **Test Images** - Generated output images from this commit\n`;
          summaryContent += `- **Golden Masters** - Reference images for comparison\n\n`;
          
          summaryContent += `---\n\n`;
          summaryContent += `> ðŸ’¡ **Tip:** This summary is automatically generated for every commit to main branches that contains visual outputs. `;
          summaryContent += `The post-commit visual regression testing helps catch visual regressions early in the development process.\n`;
          
          // Write to GitHub Actions step summary for prominent display
          await core.summary
            .addRaw(summaryContent)
            .write();
          
          console.log('');
          console.log('ðŸ”— Workflow Details:');
          console.log('   Run ID: ${{ github.run_id }}');
          console.log('   Triggered by: ${{ github.event_name }}');
          console.log('   Repository: ${{ github.repository }}');
          console.log('='.repeat(60));
          console.log('');
          console.log('âœ… Workflow summary created and available at:');
          console.log('   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}');
    
    - name: Create post-commit summary artifact
      run: |
        set -euo pipefail
        
        # Create a comprehensive summary file for easy download
        SUMMARY_FILE="post_commit_visual_regression_summary.md"
        
        echo "# Post-Commit Visual Regression Summary" > "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "**Test Run:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        
        echo "## Commit Details" >> "$SUMMARY_FILE"
        echo "- **Hash:** \`${{ steps.commit.outputs.commit_hash }}\`" >> "$SUMMARY_FILE"
        echo "- **Message:** ${{ steps.commit.outputs.commit_message }}" >> "$SUMMARY_FILE"
        echo "- **Author:** ${{ steps.commit.outputs.commit_author }}" >> "$SUMMARY_FILE"
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        
        echo "## Test Results" >> "$SUMMARY_FILE"
        echo "- **Images Processed:** ${{ needs.check-for-images.outputs.image_count }}" >> "$SUMMARY_FILE"
        echo "- **Overall Result:** ${{ needs.post-commit-visual-regression.result }}" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        
        case "${{ needs.post-commit-visual-regression.result }}" in
          "success")
            echo "## âœ… Test Status: PASSED" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "All generated images match their golden master references within acceptable tolerance." >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "**No visual regressions detected** - this commit is safe from a visual perspective." >> "$SUMMARY_FILE"
            ;;
          "failure")
            echo "## âŒ Test Status: FAILED" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "**Visual changes detected** that may indicate regressions or need review." >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "### Next Steps:" >> "$SUMMARY_FILE"
            echo "1. Review the detailed visual diff results in the workflow artifacts" >> "$SUMMARY_FILE"
            echo "2. Check if the visual changes are intentional" >> "$SUMMARY_FILE"
            echo "3. If changes are expected, update the golden master images" >> "$SUMMARY_FILE"
            echo "4. If changes are not expected, investigate the root cause" >> "$SUMMARY_FILE"
            ;;
          *)
            echo "## âš ï¸ Test Status: INCONCLUSIVE" >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "The visual regression test completed but the results are unclear." >> "$SUMMARY_FILE"
            echo "" >> "$SUMMARY_FILE"
            echo "### Troubleshooting:" >> "$SUMMARY_FILE"
            echo "1. Check the workflow logs for specific error messages" >> "$SUMMARY_FILE"
            echo "2. Verify test images were generated correctly" >> "$SUMMARY_FILE"
            echo "3. Ensure golden master images are accessible" >> "$SUMMARY_FILE"
            ;;
        esac
        
        echo "" >> "$SUMMARY_FILE"
        echo "## Workflow Details" >> "$SUMMARY_FILE"
        echo "- **Run ID:** ${{ github.run_id }}" >> "$SUMMARY_FILE"
        echo "- **Triggered by:** ${{ github.event_name }}" >> "$SUMMARY_FILE"
        echo "- **Repository:** ${{ github.repository }}" >> "$SUMMARY_FILE"
        echo "- **Workflow URL:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$SUMMARY_FILE"
        echo "" >> "$SUMMARY_FILE"
        echo "---" >> "$SUMMARY_FILE"
        echo "*This summary was automatically generated by the post-commit visual regression workflow.*" >> "$SUMMARY_FILE"
        
        # Display the summary in the logs as well
        echo "=== POST-COMMIT VISUAL REGRESSION SUMMARY ==="
        cat "$SUMMARY_FILE"
        echo "=============================================="
    
    - name: Upload post-commit summary
      uses: actions/upload-artifact@v4
      with:
        name: post-commit-visual-regression-summary-${{ github.run_number }}
        path: post_commit_visual_regression_summary.md
        retention-days: 30

  notify-on-skip:
    needs: check-for-images
    runs-on: ubuntu-latest
    if: needs.check-for-images.outputs.has_images == 'false'
    
    steps:
    - name: Log skipped execution
      run: |
        echo "=== POST-COMMIT VISUAL REGRESSION SKIPPED ==="
        echo "No test images found in outputs/ directory"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo ""
        echo "This is normal if this commit doesn't include visual changes."
        echo "Visual regression testing will run automatically when test images are available."
        echo "=============================================="